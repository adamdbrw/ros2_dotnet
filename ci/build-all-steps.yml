parameters:
  platform: ''
  arch: ''
  generator: 'Visual Studio 15 2017'

steps:
- script: |
    python -m pip install -U ^
      setuptools ^
      pip
    pip install -U ^
      vcstool
    pip install -U ^
      colcon-common-extensions
    pip install -U ^
      catkin_pkg ^
      EmPy ^
      lark-parser ^
      pyparsing pyyaml
    pip install -U ^
      pytest ^
      coverage ^
      mock
    pip install -U ^
      flake8 ^
      flake8-blind-except ^
      flake8-builtins ^
      flake8-class-newline ^
      flake8-comprehensions ^
      flake8-deprecated ^
      flake8-docstrings ^
      flake8-import-order ^
      flake8-quotes ^
      pep8 ^
      pydocstyle
    choco install -y ^
      cppcheck
  displayName: 'Install dependencies'

- ${{ if eq(parameters.platform, 'desktop') }}:
  - script: |
      set PATH=%PATH%;C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\MSBuild\15.0\Bin
      wget https://github.com/ros2/ros2/releases/download/release-dashing-20190614/ros2-dashing-20190614-windows-release-amd64.zip -O ros2-dashing.zip
      dir
      md \dev\ros2_dotnet_ws\src
      cd \dev\ros2_dotnet_ws
      copy $(Build.Repository.LocalPath)\ros2_dotnet_dashing.repos \dev\ros2\ros2_dotnet_dashing.repos
      vcs import src < ros2_dotnet_dashing.repos
      cd \dev\ros2_dotnet_ws\src\ros2_dotnet
      rd /s /q ros2_dotnet
      xcopy /e /i $(Build.Repository.LocalPath) ros2_dotnet
      cd \dev\ament
      call install\local_setup.bat
      cd \dev\ros2
      vcs branch
      colcon build
    displayName: 'Build ros2-dotnet for Desktop'
  - script: |
      set PATH=%PATH%;C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\MSBuild\15.0\Bin
      cd \dev\ament
      call install\local_setup.bat
      cd \dev\ros2
      vcs branch
      colcon test ^
        --packages-select ^
          rcldotnet ^
          rcldotnet_common ^
          rcldotnet_examples ^
          rosidl_generator_dotnet ^
        --cmake-args ^
          -G "${{ parameters.generator }}" ^
          -A "${{ parameters.arch }}" ^
          -DBUILD_TESTING=OFF ^
          -DTHIRDPARTY=ON ^
          -DINSTALL_EXAMPLES=OFF
      colcon test-result --verbose
    displayName: 'Test ros2-dotnet for Desktop'
